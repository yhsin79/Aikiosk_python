from flask import Flask, Response, jsonify
import face_recognition
import cv2
import os
import json
from datetime import datetime
from flask_mysqldb import MySQL
import time
from scipy.spatial import distance  # Ïú†ÏÇ¨ÎèÑ ÎπÑÍµêÏö©

app = Flask(__name__)

# MySQL ÏÑ§Ï†ï
app.config['MYSQL_HOST'] = 'localhost'
app.config['MYSQL_PORT'] = 3306  
app.config['MYSQL_USER'] = 'root'
app.config['MYSQL_PASSWORD'] = 'cindykangnam1!2@'
app.config['MYSQL_DB'] = 'aikiosk_db'

mysql = MySQL(app)

# Ï†ÑÏó≠ Î≥ÄÏàò
person_detected = False
photo_taken = False
matched_once = False  # Ï§ëÎ≥µ Îß§Ïπ≠ Î∞©ÏßÄ

@app.route('/get_data')
def get_data():
    cur = mysql.connection.cursor()
    cur.execute("SELECT * FROM coffee_menu")
    data = cur.fetchall()
    cur.close()
    return jsonify(data)

def gen_frames():
    global person_detected, photo_taken, matched_once

    cap = cv2.VideoCapture(0)

    while True:
        success, frame = cap.read()
        if not success:
            break

        face_locations = face_recognition.face_locations(frame)
        person_detected = len(face_locations) > 0

        for (top, right, bottom, left) in face_locations:
            cv2.rectangle(frame, (left, top), (right, bottom), (0, 255, 0), 2)

            # Ï§ëÎ≥µ Îß§Ïπ≠ Î∞©ÏßÄ
            if not matched_once:
                face_image = frame[top:bottom, left:right]
                rgb_face_image = cv2.cvtColor(face_image, cv2.COLOR_BGR2RGB)
                face_encoding = face_recognition.face_encodings(rgb_face_image)

                if face_encoding:
                    print("‚úÖ ÏñºÍµ¥ Ïù∏ÏΩîÎî© ÏÑ±Í≥µ")
                    vector = face_encoding[0]

                    with app.app_context():
                        cur = mysql.connection.cursor()
                        cur.execute("SELECT id, face_vector FROM detected_faces")
                        rows = cur.fetchall()

                        min_distance = float('inf')
                        matched_id = None

                        for row in rows:
                            db_id = row[0]
                            db_vector_json = row[1]
                            db_vector = json.loads(db_vector_json)
                            dist = distance.euclidean(vector, db_vector)

                            print(f"üë§ ID {db_id} Í±∞Î¶¨: {dist}")
                            if dist < min_distance:
                                min_distance = dist
                                matched_id = db_id

                        if min_distance < 0.6:
                            print(f"üéØ ÏùºÏπòÌïòÎäî ÏÇ¨Ïö©Ïûê ID: {matched_id} (Í±∞Î¶¨: {min_distance:.4f})")
                            matched_once = True  # Îã§Ïãú ÎπÑÍµêÌïòÏßÄ ÏïäÎèÑÎ°ù
                        else:
                            print("üòï Ïú†ÏÇ¨Ìïú ÏñºÍµ¥Ïù¥ ÏóÜÏäµÎãàÎã§.")

                        cur.close()

        # ÌîÑÎ†àÏûÑ Ïù∏ÏΩîÎî©
        ret, buffer = cv2.imencode('.jpg', frame)
        frame = buffer.tobytes()

        # MJPEG Ïä§Ìä∏Î¶¨Î∞ç ÏùëÎãµ
        yield (b'--frame\r\n'
               b'Content-Type: image/jpeg\r\n\r\n' + frame + b'\r\n')

    cap.release()

@app.route('/')
def index():
    return "<h2>Ïã§ÏãúÍ∞Ñ ÏñºÍµ¥ Ïù∏Ïãù ÌÖåÏä§Ìä∏</h2><img src='/video'>"

@app.route('/video')
def video():
    return Response(gen_frames(), mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/detect_person')
def detect_person():
    global person_detected
    return jsonify({'detected': person_detected})

if __name__ == '__main__':
    app.run('0.0.0.0', port=5001, debug=True)
