from flask import Flask, render_template, Response, request, jsonify
import cv2
import requests  # Spring Boot í˜¸ì¶œì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
from flask_mysqldb import MySQL
import os
from datetime import datetime

from cvlib.object_detection import draw_bbox
import cvlib as cv

app = Flask(__name__)

# MySQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •
app.config['MYSQL_HOST'] = 'localhost'  # MySQL ì„œë²„ ì£¼ì†Œ
app.config['MYSQL_PORT'] = 3306  
app.config['MYSQL_USER'] = 'root'       # MySQL ì‚¬ìš©ìëª…
app.config['MYSQL_PASSWORD'] = 'cindykangnam1!2@'  # MySQL ë¹„ë°€ë²ˆí˜¸
app.config['MYSQL_DB'] = 'aikiosk_db'  # ì‚¬ìš©í•˜ë ¤ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„

mysql = MySQL(app)

# DBì—ì„œ ì»¤í”¼ ë©”ë‰´ ê°€ì ¸ì˜¤ëŠ” API
@app.route('/get_data')
def get_data():
    cur = mysql.connection.cursor()
    cur.execute("SELECT * FROM coffee_menu")
    data = cur.fetchall()
    cur.close()
    return jsonify(data)

# OpenCV ì–¼êµ´ ì¸ì‹ ì„¤ì •
face_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')

person_detected = False  # ì‚¬ëŒ ê°ì§€ ìƒíƒœ ë³€ìˆ˜

# ë”¥ëŸ¬ë‹ ê¸°ë°˜ ì‚¬ëŒ ì¸ì‹ í•¨ìˆ˜
def gen_frames():
    global person_detected
    cap = cv2.VideoCapture(0)

    while True:
        success, frame = cap.read()
        if not success:
            break

        # ì‚¬ëŒ ì¸ì‹ (cvlib)
        bbox, labels, conf = cv.detect_common_objects(frame, confidence=0.6, model='yolov4-tiny')

        # ì‚¬ëŒ(person) ê°ì§€ë˜ë©´ ì²˜ë¦¬
        if 'person' in labels:
            frame = draw_bbox(frame, bbox, labels, conf, write_conf=True)

            if not person_detected:
                person_detected = True
                print("ğŸ”¹ ë”¥ëŸ¬ë‹ìœ¼ë¡œ ì‚¬ëŒ ê°ì§€ë¨! Spring Boot í˜¸ì¶œ ì¤‘...")

                try:
                    requests.get("http://localhost:8080/recommend?coffeeName=ì•„ë©”ë¦¬ì¹´ë…¸&coffeeImage=/img/iceAmericano.jpg")
                except requests.exceptions.RequestException as e:
                    print(f"âŒ Spring Boot í˜¸ì¶œ ì‹¤íŒ¨: {e}")
        else:
            person_detected = False  # ì‚¬ëŒì´ ì—†ëŠ” ê²½ìš° ìƒíƒœ ì´ˆê¸°í™” ê°€ëŠ¥

        # í”„ë ˆì„ ì¸ì½”ë”© ë° ì „ì†¡
        ret, buffer = cv2.imencode('.jpg', frame)
        frame = buffer.tobytes()

        yield (b'--frame\r\n'
               b'Content-Type: image/jpeg\r\n\r\n' + frame + b'\r\n')

    cap.release()


# ë©”ì¸ í˜ì´ì§€
@app.route('/')
def index():
    return render_template('index.html')

# ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°
@app.route('/video')
def video():
    return Response(gen_frames(), mimetype='multipart/x-mixed-replace; boundary=frame')

# ê°ì§€ ì—¬ë¶€ í™•ì¸ API
@app.route('/detect_person')
def detect_person():
    global person_detected
    return jsonify({'detected': person_detected})

if __name__ == '__main__':  
    app.run('0.0.0.0', port=5000, debug=True)

#ë‹¤ì‹œ localhostë§Œ ì ‘ì† ê°€ëŠ¥
#app.run(host='127.0.0.1', port=5000, debug=True)


#http://localhost:5000/

#http://192.168.45.157:5000